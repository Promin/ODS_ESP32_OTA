# CloudOTA

> CloudOTA наразі націлена лише на ESP32. Його можна розширити для роботи з ESP8266 з деякими модифікаціями.

CloudOTA дозволяє користувачеві додавати можливості ESP32 OTA до свого проекту ESP32 Arduino, використовуючи репозиторій github (або будь-який VPS) як сервер OTA. CloudOTA вилучає весь базовий код у `CloudOTA. h` бібліотеку та спрощення для користувача додавання можливостей OTA шляхом додавання лише кількох рядків кодів, як правило, перед завершенням функції `setup()`, і налаштування деяких параметрів конфігурації в `CloudOTA. h`.

CloudOTA базується на бібліотеці [Оновлення] ESP32 (https://github. com/espressif/arduino-esp32/tree/master/libraries/Update), вона дозволяє користувачеві завантажувати двійковий файл мікропрограми та вказувати, яка остання мікропрограма версія в `fw_version. txt` файл. Це дозволяє пристроям IoT, розгорнутим у польових умовах, надсилати запит до репозиторію github (або будь-якого VPS) для перевірки останнього мікропрограмного забезпечення, коли пристрій IoT виходить із глибокого сну або циклу скидання.

## Коли мені використовувати CloudOTA

ESP32-Arduino Core надає чудову бібліотеку [ArduinoOTA](https://github. com/espressif/arduino-esp32/tree/master/libraries/ArduinoOTA), яка забезпечує просту у використанні функціональність OTA, ініційовану хостом, для пристроїв які постійно знаходяться в локальній мережі. Однак він не дуже підходить для пристроїв ESP32 IoT, розгорнутих у полі, де пристрої перебувають у режимі глибокого сну більшу частину часу та прокидаються лише кілька разів на день. Ці пристрої повинні мати можливість перевіряти останню версію мікропрограми через загальнодоступний сервер і проводити OTA для самостійного оновлення (тобто ініційованого клієнтом). CloudOTA не замінює ArduinoOTA, вони служать різним цілям.

## Як ним користуватися

`CloudOTA. h` абстрагує всі деталі та надає лише дві дві функції, які користувач може легко додати до свого ескізу, щоб увімкнути функцію оновлення OTA через хмарний сервер (наприклад, через репозиторій github або будь-який VPS). `CloudOTA. ino` надає просту демонстрацію та типовий код використання CloudOTA.

### Додайте можливість CloudOTA до свого проекту

1. Скопіюйте файл `CloudOTA. h` у ваш каталог проекту або репозиторій;
2. Змініть наступні параметри в `CloudOTA. файл h` на основі середовища вашого сервера/github;

```
Рядок currentFwVersion{"2.0.0"};
String host = "raw. githubusercontent. com";
const int hostPort = 443;
Рядок fwVersionURL = "/e-tinkers/CloudOTA/master/fw_version. txt";
Рядок fwBinaryURL = "/e-tinkers/CloudOTA/master/firmware";
```

Значення `currentFwVersion` має бути значенням поточної версії мікропрограми. У прикладі «2.0.0» є поточною версією мікропрограми прикладу «CloudOTA». іно`.

Решта параметрів пов’язані з налаштуваннями вашого сервера. Параметри за замовчуванням передбачають використання репозиторію github як сервера розміщення прошивки OTA. Не забудьте замінити `e-tinkers` своїм іменем користувача github.

`fwVersionURL` визначає текстовий файл, який містить номер останньої версії мікропрограми.

`fwBinaryURL` вказав *префікс* двійкового файлу мікропрограми.

3. Додайте три рядки коду нижче до ескізу проекту. Не забудьте також додати заголовок `#include "CloudOTA. h"` у свій ескіз. Це забезпечить ваш ескіз можливістю CloudOTA кожного разу, коли ескіз виходить із режиму глибокого сну або скидається апаратне/програмне забезпечення.

```
#include "CloudOTA. h"

void setup() {
    // ваш звичайний код налаштування тут

    // Додайте функціональність Cloud OTA
    if (newFirmwareAvailable()) {
        оновлення прошивки();
    }
}
```

4. Створіть `fw_version. txt` у каталозі проекту, вміст `fw_version. txt` має відповідати значенню, яке використовується в параметрі `currentFwVersion` в `CloudOTA". h`.

5. Прошити пристрій ESP32 за допомогою останнього коду з підтримкою OTA. Це все! `CloudOTA. ino` складається з простого ескізу бойлера, який має версію мікропрограми 2.0.0. Він перевірить наявність останньої версії мікропрограми з `fw_version. txt` під час наступного скидання або пробудження з глибокого сну.

### Оновіть мікропрограму

1. Якщо ви внесли зміни до свого проекту в майбутньому (наприклад, додайте код блимання світлодіода, показаний у прикладі).

2. Змініть свою `currentFwVersion` на "2.0.1" у `CloadOTA. h`.

3. Натисніть «Sketch -> Export Compiled Binary» з Arduino IDE, щоб експортувати останній ескіз;

4. Перейдіть до каталогу вашого ескізу, і там має бути двійковий файл, названий відповідно до імені вашого файлу ескізу `<назва_файлу_ескізу>. я не. esp32. bin`. Перейменуйте його на `firmware2.0.1. bin`, де `firmware` має бути назвою префікса, який використовується у вашому параметрі конфігурації `fwBinaryURL`, згаданому в `CloudOTA. h`, а `2.0.1` має бути поточним номером версії, указаним у `currentFwVersion` в `CloudOTA". h`.

3. Оновіть `fw_version. txt` відповідно до `2.0.1`.

4. Виконайте git push, щоб надіслати останній проект (і `firmware.2.0.1. bin`) на github. Ваш IoT-пристрій автоматично оновиться під час наступного скидання або виходу з режиму глибокого сну, і ви побачите, що світлодіодний індикатор блимає з новою мікропрограмою.